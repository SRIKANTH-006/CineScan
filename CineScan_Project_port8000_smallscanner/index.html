<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CineScan+ — QR Ticket Scanner</title>

  <!-- Libraries -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#071023;
      --panel:#0b1530;
      --muted:#9fb4d6;
      --neon:#19a0ff; /* cyber blue */
      --accent:#0fd8ff33;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 10%, #031029 0%, var(--bg) 30%), linear-gradient(180deg, rgba(9,20,38,0.6), rgba(3,6,16,0.6));
      color:#dbeeff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
    }

    .app {
      max-width:1100px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:28px;
      align-items:start;
    }

    /* Left panel (scanner) */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), var(--glass-2));
      border-radius:14px;
      padding:20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6), 0 0 18px rgba(25,160,255,0.06) inset;
      border: 1px solid rgba(25,160,255,0.08);
    }

    .brand {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .logo {
      width:48px;height:48px;border-radius:10px;
      background:linear-gradient(135deg, rgba(25,160,255,0.18), rgba(15,216,255,0.06));
      display:flex;align-items:center;justify-content:center;
      font-family: Orbitron, monospace;
      color:var(--neon);
      font-weight:700;font-size:18px;
      box-shadow:0 6px 18px rgba(15,216,255,0.06);
    }
    .title {
      font-family: Orbitron, monospace;
      font-size:18px;
      letter-spacing:0.6px;
    }
    .subtitle { color:var(--muted); font-size:13px; margin-top:3px; }

    #reader {
      width:100%;
      height:360px;
      background: linear-gradient(180deg, rgba(10,22,40,0.6), rgba(2,8,20,0.6));
      border-radius:10px;
      border: 1px dashed rgba(25,160,255,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      margin-top:12px;
      box-shadow: 0 8px 30px rgba(2,8,20,0.7);
    }

    /* Neon frame lines */
    #reader::before, #reader::after {
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background: linear-gradient(90deg, transparent 0 6px, rgba(25,160,255,0.035) 6px 7px, transparent 7px 100%);
      mix-blend-mode:screen;
    }

    .status {
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .result {
      flex:1;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.018), rgba(255,255,255,0.01));
      border-radius:10px;
      border:1px solid rgba(25,160,255,0.06);
      font-weight:600;
      color:#dff6ff;
      min-height:48px;
      display:flex;align-items:center;
      gap:10px;
    }
    .result .muted { color:var(--muted); font-weight:400; font-size:13px; }
    .actions { display:flex; gap:10px; align-items:center; }

    .btn-neon {
      background: linear-gradient(90deg, rgba(25,160,255,0.14), rgba(15,216,255,0.06));
      border: 1px solid rgba(25,160,255,0.16);
      color:var(--neon);
      padding:8px 12px;border-radius:10px;font-weight:700;
      box-shadow: 0 6px 18px rgba(15,160,255,0.06);
    }

    /* Right panel (log & info) */
    .right {
      display:flex;flex-direction:column;gap:18px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.015), var(--glass));
      border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 8px 30px rgba(1,6,12,0.6);
    }

    .metrics { display:flex; gap:12px; }
    .metric {
      flex:1; padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(10,20,36,0.4), rgba(8,14,28,0.1));
      border:1px solid rgba(15,160,255,0.05);
      text-align:left;
    }
    .metric h3{ margin:0; font-family:Orbitron, monospace; color:var(--neon); font-size:18px; }
    .metric p{ margin:0; color:var(--muted); font-size:13px; margin-top:6px; }

    .log {
      max-height:220px; overflow:auto; margin-top:8px;
      font-family:monospace; font-size:13px;
      color:#bfe9ff;
    }
    .log .entry { padding:10px;border-bottom:1px dashed rgba(255,255,255,0.02); display:flex; justify-content:space-between; gap:12px; }
    .log .ts { color:var(--muted); font-size:12px; min-width:90px; text-align:left; }

    footer { text-align:center; color:var(--muted); margin-top:18px; font-size:13px; }

    /* Responsive */
    @media (max-width:980px){
      .app{ grid-template-columns:1fr; padding:12px; gap:16px; }
      #reader{ height:320px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left: Scanner -->
    <div class="panel">
      <div class="brand">
        <div class="logo">CS+</div>
        <div>
          <div class="title">CineScan+ <span style="font-size:12px;color:var(--muted);font-weight:500">QR Ticket Scanner</span></div>
          <div class="subtitle">Realtime validation • Vigilant mode</div>
        </div>
      </div>

      <div id="reader" aria-label="QR reader area">
        <div style="text-align:center;color:var(--muted);">
          <div style="font-weight:700;color:var(--neon);font-family:Orbitron, monospace">READY</div>
          <div style="font-size:13px;margin-top:6px">Point camera at ticket QR</div>
        </div>
      </div>

      <div class="status">
        <div class="result" id="result"> <span class="muted">No scan yet</span></div>
        <div class="actions">
          <button class="btn-neon" id="toggleCamera">Pause</button>
        </div>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px;">
        <div style="flex:1" class="muted">Scanner FPS: <strong id="fps">10</strong></div>
        <div style="flex:1;text-align:right" class="muted">Mode: <strong>Vigilant</strong></div>
      </div>
    </div>

    <!-- Right: Info & logs -->
    <div class="right">
     <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
  <div>
    <div style="font-family:Orbitron, monospace;color:var(--neon)">Quick Controls</div>
    <div style="color:var(--muted);font-size:13px;margin-top:6px">Manual verify / reset stats / admin</div>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn-neon" id="manualVerify">Manual Verify</button>
    <button class="btn-neon" id="resetStats">Reset</button>
    <button class="btn-neon" id="goAdmin">Admin</button>
  </div>
</div>

</div>


        <div class="metrics" style="margin-top:12px;">
          <div class="metric">
            <h3 id="totalScans">0</h3>
            <p>Total scans</p>
          </div>
          <div class="metric">
            <h3 id="validCount">0</h3>
            <p>Valid tickets</p>
          </div>
          <div class="metric">
            <h3 id="fraudCount">0</h3>
            <p>Flagged / Reused</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-family:Orbitron, monospace;color:var(--neon)">Scan Log</div>
        <div class="log" id="logArea">
          <!-- dynamic entries -->
        </div>
      </div>
      <footer>© CineScan+ — Cyber Blue UI • Built for vigilant scanning</footer>
    </div>
  </div>

  <script>
    // Basic scanner + UI wiring (works offline with existing backend)
    const resultEl = document.getElementById('result');
    const logArea = document.getElementById('logArea');
    const totalScans = document.getElementById('totalScans');
    const validCount = document.getElementById('validCount');
    const fraudCount = document.getElementById('fraudCount');
    const lastSync = document.getElementById('lastSync');
    const fpsEl = document.getElementById('fps');

    let counts = { total:0, valid:0, fraud:0 };

    function addLog(message, type='info') {
      const ts = new Date().toLocaleTimeString();
      counts.total += (type!=='info') ? 1 : 1;
      totalScans.innerText = counts.total;
      if(type==='valid') validCount.innerText = ++counts.valid;
      if(type==='fraud') fraudCount.innerText = ++counts.fraud;

      const node = document.createElement('div');
      node.className = 'entry';
      node.innerHTML = `<div style="display:flex;flex-direction:column">
                          <div style="font-weight:600">${message}</div>
                          <div class="muted ts">${ts}</div>
                        </div>
                        <div style="color:${ type==='fraud' ? '#ff8b8b' : (type==='valid' ? '#baf7d6' : '#9fb4d6') }">${type.toUpperCase()}</div>`;
      logArea.prepend(node);
    }

    // scanner success handler
    async function onScanSuccess(decodedText) {
      // optimistic UI update
      resultEl.innerHTML = `<div style="font-weight:700">${decodedText}</div>`;
      addLog('Scanned: ' + decodedText, 'info');

      // verify with backend
      try {
        const res = await fetch("http://127.0.0.1:8000/verify", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ qr_data: decodedText })
        });
        const data = await res.json();
        lastSync.innerText = new Date().toLocaleTimeString();

        if(data && data.status === 'ok' && data.valid === true) {
          resultEl.innerHTML = `<div style="font-weight:700;color:#baf7d6">VALID — ${data.message || 'OK'}</div>`;
          addLog('VALID — ' + (data.message||'OK'), 'valid');
        } else {
          resultEl.innerHTML = `<div style="font-weight:700;color:#ff9b9b">FLAGGED — ${data.message || 'Invalid / Reused'}</div>`;
          addLog('FLAGGED — ' + (data.message||'Invalid / Reused'), 'fraud');
        }
      } catch (err) {
        resultEl.innerHTML = `<div style="font-weight:700;color:var(--muted)">Network error</div>`;
        addLog('Network error while verifying: ' + err.message, 'info');
      }
    }

    // initialize scanner
    const html5QrCode = new Html5Qrcode("reader", /* verbose= */ false);
    let isRunning = true;
    const constraints = { facingMode: "environment" };
    const config = { fps: 10, qrbox: { width: 300, height: 300 } };
    fpsEl.innerText = config.fps;

    html5QrCode.start(constraints, config, onScanSuccess).catch(err=>{
      // fallback UI
      document.getElementById('reader').innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Camera unavailable — please allow camera permissions or use a supported device.</div>';
    });

    // Pause/resume toggle
    document.getElementById('toggleCamera').addEventListener('click', async () => {
      const btn = document.getElementById('toggleCamera');
      if(isRunning){
        await html5QrCode.stop();
        btn.innerText = 'Resume';
        isRunning = false;
      } else {
        html5QrCode.start(constraints, config, onScanSuccess);
        btn.innerText = 'Pause';
        isRunning = true;
      }
    });

    // Quick controls
    document.getElementById('manualVerify').addEventListener('click', ()=>{
      const code = prompt('Enter QR data / code to verify manually:');
      if(code) onScanSuccess(code);
    });
    document.getElementById('resetStats').addEventListener('click', ()=>{
      counts = { total:0, valid:0, fraud:0 };
      totalScans.innerText = validCount.innerText = fraudCount.innerText = '0';
      logArea.innerHTML = '';
      lastSync.innerText = '--';
      addLog('Stats reset by operator', 'info');
    });
    // Admin button navigation
document.getElementById('goAdmin').addEventListener('click', () => {
  window.location.href = 'admin.html';
});


  </script>
</body>
</html>
